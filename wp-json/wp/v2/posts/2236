{"id":2236,"date":"2009-12-20T09:30:51","date_gmt":"2009-12-20T17:30:51","guid":{"rendered":"https:\/\/www.ultrasaurus.com\/?p=2236"},"modified":"2014-04-09T10:50:24","modified_gmt":"2014-04-09T17:50:24","slug":"creating-a-custom-rake-task","status":"publish","type":"post","link":"https:\/\/www.ultrasaurus.com\/2009\/12\/creating-a-custom-rake-task\/","title":{"rendered":"creating a custom rake task"},"content":{"rendered":"<p>There&#8217;s a nice <a href=\"http:\/\/railscasts.com\/episodes\/66-custom-rake-tasks\">Railscast introduction to rake<\/a> for Rails, which goes into a number of other important details that aren&#8217;t covered in this post.  Below is a little tutorial of creating a Rails rake task and getting it to run remotely on heroku.<\/p>\n<h2>Introduction to Rake<\/h2>\n<p>In lib\/tasks, create a file called greet.rake<\/p>\n<pre>\r\ntask :greet do\r\n   puts \"Hello world\"\r\nend\r\n<\/pre>\n<p>By naming the task .rake and putting it in this special place rails will automatically pick it up and make it available to you.  You can see it listed if you type: rake -T on the command line.  To run it:<\/p>\n<pre>\r\nrake greet\r\n<\/pre>\n<p>which will print &#8220;Hello world&#8221;<\/p>\n<p>to run one task before another, specify a dependency like this (multiple tasks may be specified in the same file):<\/p>\n<pre>\r\ntask :ask =&gt; :greet do\r\n   puts \"How are you?\"\r\nend\r\n<\/pre>\n<h2>Writing a Practical Rake Task<\/h2>\n<p>Now for the task at hand, I&#8217;m going to create a rake task which creates a bunch of fake data for me to test with.  First I&#8217;ll create a little experimental app:<\/p>\n<pre>\r\nrails rake_example\r\ncd rake example\r\nscript\/generate scaffold person first_name:string last_name:string\r\nrake db:migrate\r\nrails generate admin fake_people\r\n<\/pre>\n<p>Here&#8217;s the rake task (lib\/tasks\/fake_people.rake):<\/p>\n<pre>\r\nrequire 'faker'\r\n\r\nnamespace :admin  do\r\n  desc \"create some fake data\"\r\n  task :fake_people =&gt; :environment do\r\n    print \"How many fake people do you want?\"\r\n    num_people = $stdin.gets.to_i\r\n    num_people.times do\r\n      Person.create(:first_name =&gt; Faker::Name.first_name,\r\n                    :last_name =&gt; Faker::Name.last_name)\r\n    end\r\n    print \"#{num_people} created.n\"\r\n  end\r\nend\r\n<\/pre>\n<p>Note that I&#8217;m using the faker gem (<a href=\"http:\/\/faker.rubyforge.org\/rdoc\/\">docs here<\/a>) and I created a task dependency on loading the rails environment so I could access my Person model.<\/p>\n<p>Now I can run<\/p>\n<pre>\r\nrake admin:fake_people\r\n<\/pre>\n<p>and it will prompt me to ask how many I want and then it will create them.  Cool goodness, yes?<\/p>\n<h2>Running Remotely on Heroku<\/h2>\n<p>We&#8217;re not done yet.  I want to deploy this on heroku and be able to run the task remotely.  For this, there are two gotchas, first I can&#8217;t run an interactive script remotely; also I need to tell heroku that I am using the fake gem and make sure it is installed.<\/p>\n<h3>1) removing interactivity<\/h3>\n<p>Instead of an interactive script, we can set an environment variable or command line argument (thanks to a <a href=\"http:\/\/groups.google.com\/group\/heroku\/browse_thread\/thread\/775f445e5b11e498\/\">tip by Adam Wiggins<\/a>).  <\/p>\n<p>My modified task looks like this:<\/p>\n<pre>\r\nrequire 'faker'\r\n\r\nnamespace :admin  do\r\n  desc \"create some fake data\"\r\n  task :fake_people =&gt; :environment do\r\n    num_people = ENV['NUM_RECORDS'].to_i\r\n    num_people.times do\r\n      Person.create(:first_name =&gt; Faker::Name.first_name,\r\n                    :last_name =&gt; Faker::Name.last_name)\r\n    end\r\n    print \"#{num_people} created.n\"\r\n  end\r\nend\r\n<\/pre>\n<p>which I can call locally from the command line like this:<\/p>\n<pre>\r\nrake admin:fake_people NUM_RECORDS=1\r\n<\/pre>\n<h3>2) adding gem to heroku<\/h3>\n<p>I need to create a <a href=\"http:\/\/blog.heroku.com\/archives\/2009\/3\/10\/gem_manifests\/\">gems manifest<\/a>, which sounds fancy, but is simply creating a .gems file at the root of my app with contents similar to what I would put in my config environment.rb to specify that my app requires a gem:<\/p>\n<pre>\r\nfaker --version \"&gt;=0.3.1\"\r\n<\/pre>\n<h3>3) Deploy and Run<\/h3>\n<p>So I can deploy my app to heroku with the usual steps<\/p>\n<pre>\r\ngit init\r\ngit add .\r\ngit commit -m \"example app for rake script testing\"\r\nheroku create\r\ngit push heroku master\r\nheroku rake db:migrate\r\n<\/pre>\n<p>and run the task remotely:<\/p>\n<pre>\r\nheroku run rake admin:fake_people NUM_RECORDS=1\r\n<\/pre>\n","protected":false},"excerpt":{"rendered":"<p>There&#8217;s a nice Railscast introduction to rake for Rails, which goes into a number of other important details that aren&#8217;t covered in this post. Below is a little tutorial of creating a Rails rake task and getting it to run remotely on heroku. Introduction to Rake In lib\/tasks, create a file called greet.rake task :greet&hellip; <a href=\"https:\/\/www.ultrasaurus.com\/2009\/12\/creating-a-custom-rake-task\/\">Continue reading <span class=\"meta-nav\">&rarr;<\/span><\/a><\/p>\n","protected":false},"author":84,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[2],"tags":[],"_links":{"self":[{"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/posts\/2236"}],"collection":[{"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/users\/84"}],"replies":[{"embeddable":true,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/comments?post=2236"}],"version-history":[{"count":0,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/posts\/2236\/revisions"}],"wp:attachment":[{"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/media?parent=2236"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/categories?post=2236"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/tags?post=2236"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}