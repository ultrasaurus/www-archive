{"id":600,"date":"2008-12-29T09:39:07","date_gmt":"2008-12-29T17:39:07","guid":{"rendered":"https:\/\/www.ultrasaurus.com\/sarahblog\/2008\/12\/rails-2-day-4-rcov-and-more-behavior-driven-development\/"},"modified":"2008-12-29T09:39:07","modified_gmt":"2008-12-29T17:39:07","slug":"rails-2-day-4-rcov-and-more-behavior-driven-development","status":"publish","type":"post","link":"https:\/\/www.ultrasaurus.com\/2008\/12\/rails-2-day-4-rcov-and-more-behavior-driven-development\/","title":{"rendered":"rails 2 day 4: rcov and more behavior-driven development"},"content":{"rendered":"<p>Today, we&#8217;ll follow modified steps, as recommended by <a href=\"http:\/\/blog.mattwynne.net\/\">Matt Wynne<\/a> who suggested <a href=\"http:\/\/www.ruby-forum.com\/topic\/174015#762387\">refactoring to remove duplication<\/a> as an extremely important step:<\/p>\n<ol>\n<li>Describe a feature<\/li>\n<li>Execute the feature and Watch it fail<\/li>\n<li>Write the code to make it pass<\/li>\n<li>Refactor<\/li>\n<li>Go to step 2<\/li>\n<\/ol>\n<p>Also, since we&#8217;re using the generate scaffold command, we should remove unused code when refactoring as suggested in the original <a href=\"http:\/\/rails.homelinux.org\/\">Four Days on Rails<\/a> tutorial.  I&#8217;ll also be using RCov to look at how much the feature description covers the code.  I think this is a helpful way of digging into what the scaffold command actually did.  This tutorial picks up where <a href=\"https:\/\/www.ultrasaurus.com\/code\/2008\/12\/rails-2-day-3.html\">day 3<\/a> finished.  You can skip day 1 or 2, if you already have installed Ruby on Rails and know a little bit about it.<\/p>\n<p>Today we will:<\/p>\n<ol>\n<li><a href=\"#install\">Install RCov<\/a><\/li>\n<li><a href=\"#coverage\">Look at Code Coverage<\/a><\/li>\n<li><a href=\"#more\">Write more scenarios<\/a>\n<ol>\n<li><a href=\"#create\">Create<\/a><\/li>\n<li><a href=\"#edit\">Edit<\/a><\/li>\n<li><a href=\"#delete\">Delete<\/a><\/li>\n<\/ol>\n<\/li>\n<li><a href=\"#refactor\">Refactor to remove duplication<\/a><\/li>\n<li><a href=\"#review\">Review what we learned<\/a><\/li>\n<\/ol>\n<p>&nbsp;<\/p>\n<hr \/>\n<p>&nbsp;<\/p>\n<p><a name=\"install\"><\/p>\n<h1>Install RCov<\/h1>\n<p><\/a><\/p>\n<p>Elaborating slightly on the <a href=\"http:\/\/github.com\/aslakhellesoy\/cucumber\/wikis\/using-rcov-with-cucumber-and-rails\">nice instructions<\/a> on the cucumber wiki, Aslak recommends that you use <a href=\"http:\/\/github.com\/spicycode\/rcov\/tree\/master\">spicycode&#8217;s RCov<\/a> instead of the &#8216;official&#8217; one, &#8220;as it currently segfaults too much for most people&#8217;s taste.&#8221;<\/p>\n<pre class=\"code\">\ngem sources -a http:\/\/gems.github.com\ngem uninstall rcov\ngem install spicycode-rcov\n<\/pre>\n<p>Second, you&#8217;ll need to open up the cucumber generated task file and set the rcov config option (add one line in bold).<\/p>\n<p><code><strong>in todolist\/lib\/tasks\/cucumber.rake<\/strong><\/code><\/p>\n<blockquote><p><code><br \/>\n$:.unshift(RAILS_ROOT + '\/vendor\/plugins\/cucumber\/lib')<br \/>\nrequire 'cucumber\/rake\/task'<br \/>\nCucumber::Rake::Task.new(:features) do |t|<br \/>\n&nbsp;&nbsp;t.cucumber_opts = \"--format pretty\" <br \/>\n&nbsp;&nbsp;<strong>t.rcov = true<\/strong><br \/>\nend<br \/>\ntask :features =&gt; 'db:test:prepare'<br \/>\n<\/code><\/p><\/blockquote>\n<p><a name=\"coverage\"><\/p>\n<h1>Look at Code Coverage<\/h1>\n<p><\/a><\/p>\n<p>Now when you run:<\/p>\n<pre class=\"code\">\nrake features\n<\/pre>\n<p>And you point your browser at:  <code>http:\/\/localhost\/todolist\/coverage\/<\/code><\/p>\n<p>You&#8217;ll see:<\/p>\n<p><a href=\"http:\/\/farm4.static.flickr.com\/3232\/3145974854_02eb274fae_o.png\"><img src=\"http:\/\/farm4.static.flickr.com\/3232\/3145974854_eecc2243ec.jpg\" \/><\/a><\/p>\n<p>We can see that we don&#8217;t have complete coverage in two files: webrat.rb and tasks_controller.rb  The first doesn&#8217;t matter, since it is part of the test framework (in fact there ought to be some way to exclude that), but we need to be concerned that half of our generated controller code is untested.  By clicking on the filename, we can see the detailed coverage where the lines of code that are not covered are highlighted in red:<\/p>\n<p><a href=\"http:\/\/farm4.static.flickr.com\/3093\/3145974882_6c91b6a2a2_o.png\"><img src=\"http:\/\/farm4.static.flickr.com\/3093\/3145974882_e734e02fd4.jpg\" \/><\/a><\/p>\n<p>It is unsurprising that we&#8217;re covering just 40% of this file, since we&#8217;ve written just <a href=\"https:\/\/www.ultrasaurus.com\/code\/2008\/12\/rails-2-day-3.html\">a single of scenario so far<\/a>. <\/p>\n<p><a name=\"more\"><\/p>\n<h1>More Scenarios<\/h1>\n<p><\/a><\/p>\n<p>Let&#8217;s look at what isn&#8217;t getting covered.<\/p>\n<ul>\n<li>show<\/li>\n<li>new<\/li>\n<li>edit <\/li>\n<li>update (called from edit)<\/li>\n<li>destroy<\/li>\n<li>create (called from new)<\/li>\n<\/ul>\n<p><a name=\"create\"><\/p>\n<h2>Create<\/h2>\n<p><\/a><\/p>\n<p>To create a task, we can leverage quite a bit of webrat, plus a step we wrote before.  Add the following scenario to the feature file:<\/p>\n<p><strong><code>in features\/tasklist.feature<\/code><\/strong><\/p>\n<pre class=\"code\">\nScenario: Add a Task\nWhen I go to the tasks page\nWhen I follow \"New task\"\nWhen I fill in \"description\" with \"go shopping\"\nAnd I press \"Create\"\nThen I should see \"Task was successfully created.\"\nAnd I should see \"go shopping\"\n<\/pre>\n<p>then run<\/p>\n<pre class=\"code\">\nrake features\n<\/pre>\n<p><img src=\"http:\/\/farm4.static.flickr.com\/3248\/3146011820_a801cc35ac_o.png\" \/><\/p>\n<p>You&#8217;ll see that all of the new steps that I just wrote for the &#8220;add a Task&#8221; scenario magically worked.  What just happened?  You can see from the output of &#8220;rake features&#8221; that the first step was already defined in tasklist_steps.rb (<a href=\"https:\/\/www.ultrasaurus.com\/code\/2008\/12\/rails-2-day-3.html\">see day 3<\/a>), but each of the others is defined in webrat_steps.rb.  With a little practice you&#8217;ll learn the webrat lingo, and it&#8217;ll save you a bunch of time.  Pretty cool, huh?<\/p>\n<p>Now if we go back to look at our code coverage (http:\/\/localhost\/todolist\/coverage\/), the tasks_controller.rb coverage is at 64.7%.<br \/>\n<a href=\"http:\/\/farm4.static.flickr.com\/3098\/3145039593_eafa164a16_o.png\"><img src=\"http:\/\/farm4.static.flickr.com\/3098\/3145039593_9c48642385.jpg\" \/><\/a><br \/>\nClicking on the file, we can see the lines of code that are now tested.  We&#8217;ve covered new and half of create.  (Not quite sure what would cause that error condition, but we&#8217;ll move on for now.)<\/p>\n<p><a name=\"edit\"><\/p>\n<h2>Edit<\/h2>\n<p><\/a><\/p>\n<p>Now we&#8217;ll do some behavior-driven development, since the auto-generated task list and edit workflow isn&#8217;t exactly what I wanted.  This is what I see after adding the &#8220;go shopping&#8221; task manually:<\/p>\n<p><img src=\"http:\/\/farm4.static.flickr.com\/3089\/3145209431_565cc149db_o.png\" \/><\/p>\n<p>I don&#8217;t really need the &#8220;show&#8221; link (since my task only has its description as data and that&#8217;s shown in the list and since I&#8217;m removing that, I can just make the description itself as a link.  So I want to add two scenarios to support my intended edit behavior:<\/p>\n<ul>\n<li>Clicking on the description link allows edit<\/li>\n<li>After Editing I return to the task list<\/li>\n<\/ul>\n<pre class=\"code\">\nScenario: Clicking on description link allows edit\nGiven that I have created a task \"go shopping\"\nWhen I go to the tasks page\nWhen I follow \"Go Shopping\"\nThen I should see \"Editing Task\"\n<\/pre>\n<p><img src=\"http:\/\/farm4.static.flickr.com\/3107\/3145248655_c651d3f708_o.png\" \/><\/p>\n<p>As expected, the new scenario fails.  Time to write the code!  The list of tasks can be found in app\/views\/tasks\/index.html.erb<\/p>\n<p><img src=\"http:\/\/farm4.static.flickr.com\/3098\/3146118822_bbf8cd83db_o.png\" \/><\/p>\n<p>As you can see that I&#8217;ve modified line 10 to link the description to the edit task page.  Note that (h task.description) needs to be enclosed in parens.  We want to keep the h, just to make sure that the description is properly escaped, in case it has special characters like &#8216;&lt;&#039;.  I also removed show and edit links.  Now, when I run &#039;rake features&#039; all of my steps pass.  Yay!<\/p>\n<p>But wait!  I still have the &#8220;show&#8221; method in my controller.  What&#8217;s up with that?  If I look at my coverage report, it shows that it is being called.  In my controller, both create and update redirect to @task (which is the &#8220;show&#8221; page), like I did in <a href=\"https:\/\/www.ultrasaurus.com\/code\/2008\/12\/rails-day2.html#edit-controller\">day 2<\/a>, I&#8217;ll modify those to redirect to index instead.<\/p>\n<p><code>in <strong>app\/controllers\/task_controller.rb<\/strong><\/code><\/p>\n<p>change:<\/p>\n<p><code>       format.html { redirect_to(@task) }<\/code><\/p>\n<p>to:<\/p>\n<p><code>format.html { redirect_to :action =&gt; \"index\"  } <\/code><\/p>\n<p>and remove the show method<\/p>\n<p>Rerun &#8216;rake features&#8217; just to make sure all is good.  And you can now see that the tasks_controller code coverage is at 62%.  We&#8217;re calling edit, but not yet update&#8230; on to the next scenario.<\/p>\n<pre class=\"code\">\nScenario: After Editing I return to the task list\nGiven that I have created a task \"go shopping\"\nWhen I go to the tasks page\nWhen I follow \"Go Shopping\"\nAnd I fill in \"description\" with \"buy bagels\"\nAnd I press \"Update\"\nThen I should see \"Task was successfully updated.\"\nAnd I should see \"Listing tasks\"\nAnd I should see \"buy bagels\"\n<\/pre>\n<p>When I run &#8220;rake features&#8221; the scenario passes. (Yay!)  I  don&#8217;t know how to hit the error condition in update either, but I&#8217;ll leave that for another day.<\/p>\n<p><a name=\"delete\"><\/p>\n<h2>Delete<\/h2>\n<p><\/a><\/p>\n<p>I left delete for last since it is a bit trickier.  With the design of the app, there is a &#8220;destroy&#8221; link for each task in the list, so I have to figure out which one to click.<\/p>\n<p> I found this handy step definition in an <a href=\"http:\/\/github.com\/aslakhellesoy\/cucumber_rails\/tree\/master\/features\/step_definitions\/lorry_steps.rb\">example by Aslak<\/a>:<\/p>\n<pre class=\"code\">\nWhen \/^I delete the (d+)(?:st|nd|rd|th) lorry$\/ do |pos|\nvisit lorries_url\nwithin(\"table &gt; tr:nth-child(#{pos.to_i+1})\") do\nclick_link \"Destroy\"\nend\nend\n<\/pre>\n<p>When I first looked at that I thought <code>&gt; tr:nth-child<\/code> was some wild new Ruby syntax, but the kind folk on the RSpec list <a href=\"http:\/\/www.ruby-forum.com\/topic\/174063#new\">answered my question<\/a> by pointing me to the <a href=\"http:\/\/www.w3.org\/TR\/CSS2\/selector.html#child-selectors\">CSS selector doc<\/a>. I had forgotten that &gt; was a CSS selector since I had never actually used that selector before.  That hint combined with <a href=\"http:\/\/www.ruby-forum.com\/topic\/171269\">a previous thread<\/a> and some digging around to brush up my Ruby and Rail skills led me to a solution. Here is my scenario for delete:<\/p>\n<pre class=\"code\">\nScenario: Delete a Task\nGiven that I have created a task \"task 1\"\nWhen I go to the tasks page\nAnd I click \"delete\" for \"task 1\"\nThen I should see \"Listing tasks\"\nAnd I should not see \"task 1\"\n<\/pre>\n<p>To make this work, I can define a unique DOM id for each of my table row, then I can find the id for &#8220;task 1&#8221; and then click the link inside that table row.<\/p>\n<h3>1) Define a unique DOM id for each table row<\/h3>\n<p>In <code>app\/views\/tasks\/index.html.erb<\/code>, we have some Ruby code which iterates through the list of tasks (@tasks) and for each &#8216;task&#8217; there is a table row.  To add a unique id for the table row, I insert a snippet of ruby code within &lt;% &#8230; %&gt; which evaluates to a unique string.  In this case I use the string &#8220;task&#8221; plus to id of the task itself, generating task4, task5 or whatever.<\/p>\n<blockquote><p><code><br \/>\n&lt;% for task in @tasks %&gt;<br \/>\n&nbsp;&nbsp;&lt;tr id=&quot;&lt;%=&quot;task&quot;+task.id.to_s%&gt;&quot;&gt;<br \/>\n<\/code><\/p><\/blockquote>\n<h3>2) Find the id for &#8220;task 1&#8221;<\/h3>\n<p>Given the description of a task, I need to find its id.  In the <a href=\"http:\/\/api.rubyonrails.org\/classes\/ActiveRecord\/Base.html\">ActiveRecord::Base API docs<\/a>, it describes some handy syntax for finding by attribute value. &#8220;Dynamic attribute-based finders are a cleaner way of getting (and\/or creating) objects by simple queries without turning to SQL. They work by appending the name of an attribute to find_by_, find_last_by_, or find_all_by_.&#8221;  Since the attribute I have is &#8220;description,&#8221; I can call<\/p>\n<pre class=\"code\">\ntask = Task.find_by_description(desc)\n<\/pre>\n<p>to get the task object where the description attribute matches the given parameter.<\/p>\n<h3>3) Click the link inside the table row<\/h3>\n<p>Putting it all together I can create a step definition like this:<\/p>\n<pre>\nWhen \/^I click \"delete\" for \"(.*)\"$\/ do |desc|\ntask = Task.find_by_description(desc)\nwithin(\"table &gt; tr#task\"+task.id.to_s) do\nclick_link \"Destroy\"\nend\nend\n<\/pre>\n<p>I run &#8220;rake features&#8221; and all is good.  The only thing left to do is to rename the &#8220;Destroy&#8221; link to be &#8220;delete&#8221; as I described it and fix up the step to have a more general definition:<\/p>\n<pre class=\"code\">\nWhen \/^I click \"(.*)\" for \"(.*)\"$\/ do |link, desc|\ntask = Task.find_by_description(desc)\nwithin(\"table &gt; tr#task\"+task.id.to_s) do\nclick_link link\nend\nend\n<\/pre>\n<p>I run &#8220;rake features&#8221; and see that 26 steps passed. Woo hoo!  Code coverage shows 83.8% of the controller file (everything but those pesky error conditions.) <\/p>\n<p><a name=\"refactor\"><\/p>\n<h1>Refactor to Remove Duplication<\/h1>\n<p><\/a><\/p>\n<p>Now that the feature description roughly covers the functionality of our app, I sought to take Matt&#8217;s advice and look at the code and see if we need to remove some duplication.<br \/>\nI looked first at the controller and found something odd:<\/p>\n<p><code>in <strong>app\/controllers\/tasks_controllers.rb<\/strong>:<\/code><\/p>\n<pre class=\"code\">\nclass TasksController  @tasks }\nend\nend\n\n# GET \/tasks\/new\n# GET \/tasks\/new.xml\ndef new\n@task = Task.new\n\nrespond_to do |format|\nformat.html # new.html.erb\nformat.xml  { render :xml =&gt; @task }\nend\nend\n\n# GET \/tasks\/1\/edit\ndef edit\n@task = Task.find(params[:id])\nend\n<\/pre>\n<p>The index and new methods repeat code, but the edit method, which I would expect to contain the same repeated 4 lines omits the code.  In fact, if I remove those lines in index and new, the app works fine.<\/p>\n<pre class=\"code\">\nclass TasksController &lt; ApplicationController\n# GET \/tasks\n# GET \/tasks.xml\ndef index\n@tasks = Task.find(:all)\nend\n\n# GET \/tasks\/new\n# GET \/tasks\/new.xml\ndef new\n@task = Task.new\nend\n\n# GET \/tasks\/1\/edit\ndef edit\n@task = Task.find(params[:id])\nend\n<\/pre>\n<p>When I run &#8216;rake features&#8217; all the steps pass and poking at the application also yields success.  What&#8217;s going on?  There must be something happening by default.  At first I couldn&#8217;t figure out where ApplicationController was defined, but an answer to my <a href=\"http:\/\/www.ruby-forum.com\/topic\/174419#764163\">question on the Rails list<\/a> pointed out that ApplicationController is one of the classes created by generate scaffold (defined in app\/controllers\/application.rb). Looking at the code (and comments) we can see that it simply sets some defaults for any controller in the application. ApplicationController is a subclass of ActionController::Base, which we can look up in the <a href=\"http:\/\/api.rubyonrails.org\/\">Rails API Doc<\/a>.  The doc explains that &#8220;Actions, by default, render a template in the app\/views directory corresponding to the name of the controller and action after executing code in the action.&#8221;  I suppose the extra code is in there to facilitate modifying it, in case we wanted the action to do something special.<\/p>\n<p><a name=\"review\"><\/p>\n<h1>What did we learn?<\/h1>\n<p><\/a><\/p>\n<p>Today we learned about:<\/p>\n<ul>\n<li>installing and using RCov<\/li>\n<li>cucumber steps that can be quickly defined using webrat<\/li>\n<li>dynamic-attribute finders: find_by<\/li>\n<li>adding a unique DOM id to more easily test the app<\/li>\n<\/ul>\n<p>We also learned that you need to understand code in order to refactor it, but, of course, we already knew that :)<\/p>\n<p>There ends day 4, but I still haven&#8217;t completed all of the features of the Four Days on Rails tutorial.  Topics yet to learn:<\/p>\n<ul>\n<li>Adding attributes and other models: do I scaffold again or just write code?<\/li>\n<li>Associated Models<\/li>\n<li>Pagination<\/li>\n<li>Updating multiple records<\/li>\n<\/ul>\n","protected":false},"excerpt":{"rendered":"<p>Today, we&#8217;ll follow modified steps, as recommended by Matt Wynne who suggested refactoring to remove duplication as an extremely important step: Describe a feature Execute the feature and Watch it fail Write the code to make it pass Refactor Go to step 2 Also, since we&#8217;re using the generate scaffold command, we should remove unused&hellip; <a href=\"https:\/\/www.ultrasaurus.com\/2008\/12\/rails-2-day-4-rcov-and-more-behavior-driven-development\/\">Continue reading <span class=\"meta-nav\">&rarr;<\/span><\/a> <a href=\"https:\/\/www.ultrasaurus.com\/2008\/12\/rails-2-day-4-rcov-and-more-behavior-driven-development\/\">Continue reading <span class=\"meta-nav\">&rarr;<\/span><\/a><\/p>\n","protected":false},"author":84,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[2],"tags":[],"_links":{"self":[{"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/posts\/600"}],"collection":[{"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/users\/84"}],"replies":[{"embeddable":true,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/comments?post=600"}],"version-history":[{"count":0,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/posts\/600\/revisions"}],"wp:attachment":[{"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/media?parent=600"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/categories?post=600"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.ultrasaurus.com\/wp-json\/wp\/v2\/tags?post=600"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}