<!DOCTYPE html>
<html class="no-js" lang="en-US">
	<head>
				<link rel="profile" href="http://gmpg.org/xfn/11" />
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		
		<title>rails 2 day 4: rcov and more behavior-driven development &laquo; the evolving ultrasaurus</title>
		
				<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="the evolving ultrasaurus &raquo; Feed" href="https://www.ultrasaurus.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="the evolving ultrasaurus &raquo; Comments Feed" href="https://www.ultrasaurus.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="the evolving ultrasaurus &raquo; rails 2 day 4: rcov and more behavior-driven development Comments Feed" href="https://www.ultrasaurus.com/2008/12/rails-2-day-4-rcov-and-more-behavior-driven-development/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/www.ultrasaurus.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7.1"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='mailchimpSF_main_css-css'  href='https://www.ultrasaurus.com/?mcsf_action=main_css&#038;ver=5.7.1' type='text/css' media='all' />
<!--[if IE]>
<link rel='stylesheet' id='mailchimpSF_ie_css-css'  href='https://www.ultrasaurus.com/wp-content/plugins/mailchimp/css/ie.css?ver=5.7.1' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='wp-block-library-css'  href='https://www.ultrasaurus.com/wp-includes/css/dist/block-library/style.min.css?ver=5.7.1' type='text/css' media='all' />
<link rel='stylesheet' id='tw-bootstrap-css'  href='https://www.ultrasaurus.com/wp-content/themes/the-bootstrap/css/bootstrap.min.css?ver=2.0.3' type='text/css' media='all' />
<link rel='stylesheet' id='the-bootstrap-css'  href='https://www.ultrasaurus.com/wp-content/themes/the-bootstrap/style.min.css?ver=2.0.1' type='text/css' media='all' />
<style id='the-bootstrap-inline-css' type='text/css'>
body > .container{margin-top:68px;}@media(min-width: 980px){body > .container{margin-top:58px;}}
</style>
<script type='text/javascript' src='https://www.ultrasaurus.com/wp-includes/js/jquery/jquery.min.js?ver=3.5.1' id='jquery-core-js'></script>
<script type='text/javascript' src='https://www.ultrasaurus.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<script type='text/javascript' src='https://www.ultrasaurus.com/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.5.4' id='ga-external-tracking-js'></script>
<link rel="https://api.w.org/" href="https://www.ultrasaurus.com/wp-json/" /><link rel="alternate" type="application/json" href="https://www.ultrasaurus.com/wp-json/wp/v2/posts/600" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://www.ultrasaurus.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://www.ultrasaurus.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7.1" />
<link rel="canonical" href="https://www.ultrasaurus.com/2008/12/rails-2-day-4-rcov-and-more-behavior-driven-development/" />
<link rel='shortlink' href='https://www.ultrasaurus.com/?p=600' />
<link rel="alternate" type="application/json+oembed" href="https://www.ultrasaurus.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.ultrasaurus.com%2F2008%2F12%2Frails-2-day-4-rcov-and-more-behavior-driven-development%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://www.ultrasaurus.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.ultrasaurus.com%2F2008%2F12%2Frails-2-day-4-rcov-and-more-behavior-driven-development%2F&#038;format=xml" />
<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>	<style type="text/css">
				#branding hgroup {
			position: absolute !important;
			clip: rect(1px 1px 1px 1px); /* IE6, IE7 */
			clip: rect(1px, 1px, 1px, 1px);
		}
			</style>
		<!--[if lt IE 9]>
		<script src="https://www.ultrasaurus.com/wp-content/themes/the-bootstrap/js/html5shiv.min.js" type="text/javascript"></script>
		<script src="https://www.ultrasaurus.com/wp-content/themes/the-bootstrap/js/respond.min.js" type="text/javascript"></script>
	<![endif]-->
	<!-- Google Analytics Tracking by Google Analyticator 6.5.4: http://www.videousermanuals.com/google-analyticator/ -->
<script type="text/javascript">
    var analyticsFileTypes = [''];
    var analyticsSnippet = 'enabled';
    var analyticsEventTracking = 'enabled';
</script>
<script type="text/javascript">
	var _gaq = _gaq || [];
  
	_gaq.push(['_setAccount', 'UA-4313619-1']);
    _gaq.push(['_addDevId', 'i9k95']); // Google Analyticator App ID with Google
    _gaq.push(['_gat._anonymizeIp']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
		<style type="text/css" id="wp-custom-css">
			code {
	color: #70a
}

p {
	color: #333
}

blockquote p {
	font-size: 14px;
	font-weight: normal;
	padding-top: 6px;
	padding-bottom: 6px;
	padding-left: 10px;
	padding-right: 60px;
	line-height: 1.2;
}		</style>
			</head>
	
	<body class="post-template-default single single-post postid-600 single-format-standard content-sidebar">
		<div class="container">
			<div id="page" class="hfeed row">
								<header id="branding" role="banner" class="span12">
										<hgroup>
						<h1 id="site-title">
							<a href="https://www.ultrasaurus.com/" title="the evolving ultrasaurus" rel="home">
								<span>the evolving ultrasaurus</span>
							</a>
						</h1>
						<h2 id="site-description">Sarah Allen&#039;s reflections on internet software and other topics</h2>
					</hgroup>
					
					
					<nav id="access" role="navigation">
						<h3 class="assistive-text">Main menu</h3>
						<div class="skip-link"><a class="assistive-text" href="#content" title="Skip to primary content">Skip to primary content</a></div>
						<div class="skip-link"><a class="assistive-text" href="#secondary" title="Skip to secondary content">Skip to secondary content</a></div>
												<div class="navbar navbar-fixed-top navbar-inverse">
							<div class="navbar-inner">
								<div class="container">
									<!-- .btn-navbar is used as the toggle for collapsed navbar content -->
									<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
										<span class="icon-bar"></span>
										<span class="icon-bar"></span>
										<span class="icon-bar"></span>
									</a>
																		<span class="brand">the evolving ultrasaurus</span>
																		<div class="nav-collapse">
										<div class="menu-primary-container"><ul id="menu-primary" class="nav"><li id="menu-item-4272" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4272"><a href="https://www.ultrasaurus.com/about/">About</a></li>
<li id="menu-item-6605" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6605"><a href="https://www.ultrasaurus.com/speaking/">Speaking</a></li>
<li id="menu-item-6366" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6366"><a href="https://www.ultrasaurus.com/code/">Code</a></li>
<li id="menu-item-4269" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4269"><a href="https://www.ultrasaurus.com/archives/">Archives</a></li>
<li id="menu-item-4759" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4759"><a href="https://www.ultrasaurus.com/contact/">Contact</a></li>
<li id="menu-item-4697" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4697"><a href="https://www.ultrasaurus.com/ultrasaurus/">What is an ultrasaurus?</a></li>
</ul></div>	<form id="searchform" class="navbar-search pull-right" method="get" action="https://www.ultrasaurus.com/">
						<label for="s" class="assistive-text hidden">Search</label>
						<input type="search" class="search-query" name="s" id="s" placeholder="Search" />
					</form>								    </div>
								</div>
							</div>
						</div>
											</nav><!-- #access -->
									</header><!-- #branding -->
<section id="primary" class="span8">
	
		<div id="content" role="main">
		<article id="post-600" class="post-600 post type-post status-publish format-standard hentry category-code">
		
	<header class="page-header">
		<h1 class="entry-title">rails 2 day 4: rcov and more behavior-driven development</h1>		<div class="entry-meta"><span class="sep">Posted on </span><a href="https://www.ultrasaurus.com/2008/12/rails-2-day-4-rcov-and-more-behavior-driven-development/" title="9:39 am" rel="bookmark"><time class="entry-date" datetime="2008-12-29T09:39:07-08:00" pubdate>December 29, 2008</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://www.ultrasaurus.com/author/sarah/" title="View all posts by sarah" rel="author">sarah</a></span></span>		<span class="sep"> | </span>
		<span class="comments-link">
			<a href="https://www.ultrasaurus.com/2008/12/rails-2-day-4-rcov-and-more-behavior-driven-development/#comments"><strong>4</strong> Replies</a>		</span>
		</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

	<div class="entry-content clearfix">
		<p>Today, we&#8217;ll follow modified steps, as recommended by <a href="http://blog.mattwynne.net/">Matt Wynne</a> who suggested <a href="http://www.ruby-forum.com/topic/174015#762387">refactoring to remove duplication</a> as an extremely important step:</p>
<ol>
<li>Describe a feature</li>
<li>Execute the feature and Watch it fail</li>
<li>Write the code to make it pass</li>
<li>Refactor</li>
<li>Go to step 2</li>
</ol>
<p>Also, since we&#8217;re using the generate scaffold command, we should remove unused code when refactoring as suggested in the original <a href="http://rails.homelinux.org/">Four Days on Rails</a> tutorial.  I&#8217;ll also be using RCov to look at how much the feature description covers the code.  I think this is a helpful way of digging into what the scaffold command actually did.  This tutorial picks up where <a href="https://www.ultrasaurus.com/code/2008/12/rails-2-day-3.html">day 3</a> finished.  You can skip day 1 or 2, if you already have installed Ruby on Rails and know a little bit about it.</p>
<p>Today we will:</p>
<ol>
<li><a href="#install">Install RCov</a></li>
<li><a href="#coverage">Look at Code Coverage</a></li>
<li><a href="#more">Write more scenarios</a>
<ol>
<li><a href="#create">Create</a></li>
<li><a href="#edit">Edit</a></li>
<li><a href="#delete">Delete</a></li>
</ol>
</li>
<li><a href="#refactor">Refactor to remove duplication</a></li>
<li><a href="#review">Review what we learned</a></li>
</ol>
<p>&nbsp;</p>
<hr />
<p>&nbsp;</p>
<p><a name="install"></p>
<h1>Install RCov</h1>
<p></a></p>
<p>Elaborating slightly on the <a href="http://github.com/aslakhellesoy/cucumber/wikis/using-rcov-with-cucumber-and-rails">nice instructions</a> on the cucumber wiki, Aslak recommends that you use <a href="http://github.com/spicycode/rcov/tree/master">spicycode&#8217;s RCov</a> instead of the &#8216;official&#8217; one, &#8220;as it currently segfaults too much for most people&#8217;s taste.&#8221;</p>
<pre class="code">
gem sources -a http://gems.github.com
gem uninstall rcov
gem install spicycode-rcov
</pre>
<p>Second, you&#8217;ll need to open up the cucumber generated task file and set the rcov config option (add one line in bold).</p>
<p><code><strong>in todolist/lib/tasks/cucumber.rake</strong></code></p>
<blockquote><p><code><br />
$:.unshift(RAILS_ROOT + '/vendor/plugins/cucumber/lib')<br />
require 'cucumber/rake/task'<br />
Cucumber::Rake::Task.new(:features) do |t|<br />
&nbsp;&nbsp;t.cucumber_opts = "--format pretty" <br />
&nbsp;&nbsp;<strong>t.rcov = true</strong><br />
end<br />
task :features =&gt; 'db:test:prepare'<br />
</code></p></blockquote>
<p><a name="coverage"></p>
<h1>Look at Code Coverage</h1>
<p></a></p>
<p>Now when you run:</p>
<pre class="code">
rake features
</pre>
<p>And you point your browser at:  <code>http://localhost/todolist/coverage/</code></p>
<p>You&#8217;ll see:</p>
<p><a href="http://farm4.static.flickr.com/3232/3145974854_02eb274fae_o.png"><img src="http://farm4.static.flickr.com/3232/3145974854_eecc2243ec.jpg" /></a></p>
<p>We can see that we don&#8217;t have complete coverage in two files: webrat.rb and tasks_controller.rb  The first doesn&#8217;t matter, since it is part of the test framework (in fact there ought to be some way to exclude that), but we need to be concerned that half of our generated controller code is untested.  By clicking on the filename, we can see the detailed coverage where the lines of code that are not covered are highlighted in red:</p>
<p><a href="http://farm4.static.flickr.com/3093/3145974882_6c91b6a2a2_o.png"><img src="http://farm4.static.flickr.com/3093/3145974882_e734e02fd4.jpg" /></a></p>
<p>It is unsurprising that we&#8217;re covering just 40% of this file, since we&#8217;ve written just <a href="https://www.ultrasaurus.com/code/2008/12/rails-2-day-3.html">a single of scenario so far</a>. </p>
<p><a name="more"></p>
<h1>More Scenarios</h1>
<p></a></p>
<p>Let&#8217;s look at what isn&#8217;t getting covered.</p>
<ul>
<li>show</li>
<li>new</li>
<li>edit </li>
<li>update (called from edit)</li>
<li>destroy</li>
<li>create (called from new)</li>
</ul>
<p><a name="create"></p>
<h2>Create</h2>
<p></a></p>
<p>To create a task, we can leverage quite a bit of webrat, plus a step we wrote before.  Add the following scenario to the feature file:</p>
<p><strong><code>in features/tasklist.feature</code></strong></p>
<pre class="code">
Scenario: Add a Task
When I go to the tasks page
When I follow "New task"
When I fill in "description" with "go shopping"
And I press "Create"
Then I should see "Task was successfully created."
And I should see "go shopping"
</pre>
<p>then run</p>
<pre class="code">
rake features
</pre>
<p><img src="http://farm4.static.flickr.com/3248/3146011820_a801cc35ac_o.png" /></p>
<p>You&#8217;ll see that all of the new steps that I just wrote for the &#8220;add a Task&#8221; scenario magically worked.  What just happened?  You can see from the output of &#8220;rake features&#8221; that the first step was already defined in tasklist_steps.rb (<a href="https://www.ultrasaurus.com/code/2008/12/rails-2-day-3.html">see day 3</a>), but each of the others is defined in webrat_steps.rb.  With a little practice you&#8217;ll learn the webrat lingo, and it&#8217;ll save you a bunch of time.  Pretty cool, huh?</p>
<p>Now if we go back to look at our code coverage (http://localhost/todolist/coverage/), the tasks_controller.rb coverage is at 64.7%.<br />
<a href="http://farm4.static.flickr.com/3098/3145039593_eafa164a16_o.png"><img src="http://farm4.static.flickr.com/3098/3145039593_9c48642385.jpg" /></a><br />
Clicking on the file, we can see the lines of code that are now tested.  We&#8217;ve covered new and half of create.  (Not quite sure what would cause that error condition, but we&#8217;ll move on for now.)</p>
<p><a name="edit"></p>
<h2>Edit</h2>
<p></a></p>
<p>Now we&#8217;ll do some behavior-driven development, since the auto-generated task list and edit workflow isn&#8217;t exactly what I wanted.  This is what I see after adding the &#8220;go shopping&#8221; task manually:</p>
<p><img src="http://farm4.static.flickr.com/3089/3145209431_565cc149db_o.png" /></p>
<p>I don&#8217;t really need the &#8220;show&#8221; link (since my task only has its description as data and that&#8217;s shown in the list and since I&#8217;m removing that, I can just make the description itself as a link.  So I want to add two scenarios to support my intended edit behavior:</p>
<ul>
<li>Clicking on the description link allows edit</li>
<li>After Editing I return to the task list</li>
</ul>
<pre class="code">
Scenario: Clicking on description link allows edit
Given that I have created a task "go shopping"
When I go to the tasks page
When I follow "Go Shopping"
Then I should see "Editing Task"
</pre>
<p><img src="http://farm4.static.flickr.com/3107/3145248655_c651d3f708_o.png" /></p>
<p>As expected, the new scenario fails.  Time to write the code!  The list of tasks can be found in app/views/tasks/index.html.erb</p>
<p><img src="http://farm4.static.flickr.com/3098/3146118822_bbf8cd83db_o.png" /></p>
<p>As you can see that I&#8217;ve modified line 10 to link the description to the edit task page.  Note that (h task.description) needs to be enclosed in parens.  We want to keep the h, just to make sure that the description is properly escaped, in case it has special characters like &#8216;&lt;&#039;.  I also removed show and edit links.  Now, when I run &#039;rake features&#039; all of my steps pass.  Yay!</p>
<p>But wait!  I still have the &#8220;show&#8221; method in my controller.  What&#8217;s up with that?  If I look at my coverage report, it shows that it is being called.  In my controller, both create and update redirect to @task (which is the &#8220;show&#8221; page), like I did in <a href="https://www.ultrasaurus.com/code/2008/12/rails-day2.html#edit-controller">day 2</a>, I&#8217;ll modify those to redirect to index instead.</p>
<p><code>in <strong>app/controllers/task_controller.rb</strong></code></p>
<p>change:</p>
<p><code>       format.html { redirect_to(@task) }</code></p>
<p>to:</p>
<p><code>format.html { redirect_to :action =&gt; "index"  } </code></p>
<p>and remove the show method</p>
<p>Rerun &#8216;rake features&#8217; just to make sure all is good.  And you can now see that the tasks_controller code coverage is at 62%.  We&#8217;re calling edit, but not yet update&#8230; on to the next scenario.</p>
<pre class="code">
Scenario: After Editing I return to the task list
Given that I have created a task "go shopping"
When I go to the tasks page
When I follow "Go Shopping"
And I fill in "description" with "buy bagels"
And I press "Update"
Then I should see "Task was successfully updated."
And I should see "Listing tasks"
And I should see "buy bagels"
</pre>
<p>When I run &#8220;rake features&#8221; the scenario passes. (Yay!)  I  don&#8217;t know how to hit the error condition in update either, but I&#8217;ll leave that for another day.</p>
<p><a name="delete"></p>
<h2>Delete</h2>
<p></a></p>
<p>I left delete for last since it is a bit trickier.  With the design of the app, there is a &#8220;destroy&#8221; link for each task in the list, so I have to figure out which one to click.</p>
<p> I found this handy step definition in an <a href="http://github.com/aslakhellesoy/cucumber_rails/tree/master/features/step_definitions/lorry_steps.rb">example by Aslak</a>:</p>
<pre class="code">
When /^I delete the (d+)(?:st|nd|rd|th) lorry$/ do |pos|
visit lorries_url
within("table &gt; tr:nth-child(#{pos.to_i+1})") do
click_link "Destroy"
end
end
</pre>
<p>When I first looked at that I thought <code>&gt; tr:nth-child</code> was some wild new Ruby syntax, but the kind folk on the RSpec list <a href="http://www.ruby-forum.com/topic/174063#new">answered my question</a> by pointing me to the <a href="http://www.w3.org/TR/CSS2/selector.html#child-selectors">CSS selector doc</a>. I had forgotten that &gt; was a CSS selector since I had never actually used that selector before.  That hint combined with <a href="http://www.ruby-forum.com/topic/171269">a previous thread</a> and some digging around to brush up my Ruby and Rail skills led me to a solution. Here is my scenario for delete:</p>
<pre class="code">
Scenario: Delete a Task
Given that I have created a task "task 1"
When I go to the tasks page
And I click "delete" for "task 1"
Then I should see "Listing tasks"
And I should not see "task 1"
</pre>
<p>To make this work, I can define a unique DOM id for each of my table row, then I can find the id for &#8220;task 1&#8221; and then click the link inside that table row.</p>
<h3>1) Define a unique DOM id for each table row</h3>
<p>In <code>app/views/tasks/index.html.erb</code>, we have some Ruby code which iterates through the list of tasks (@tasks) and for each &#8216;task&#8217; there is a table row.  To add a unique id for the table row, I insert a snippet of ruby code within &lt;% &#8230; %&gt; which evaluates to a unique string.  In this case I use the string &#8220;task&#8221; plus to id of the task itself, generating task4, task5 or whatever.</p>
<blockquote><p><code><br />
&lt;% for task in @tasks %&gt;<br />
&nbsp;&nbsp;&lt;tr id=&quot;&lt;%=&quot;task&quot;+task.id.to_s%&gt;&quot;&gt;<br />
</code></p></blockquote>
<h3>2) Find the id for &#8220;task 1&#8221;</h3>
<p>Given the description of a task, I need to find its id.  In the <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">ActiveRecord::Base API docs</a>, it describes some handy syntax for finding by attribute value. &#8220;Dynamic attribute-based finders are a cleaner way of getting (and/or creating) objects by simple queries without turning to SQL. They work by appending the name of an attribute to find_by_, find_last_by_, or find_all_by_.&#8221;  Since the attribute I have is &#8220;description,&#8221; I can call</p>
<pre class="code">
task = Task.find_by_description(desc)
</pre>
<p>to get the task object where the description attribute matches the given parameter.</p>
<h3>3) Click the link inside the table row</h3>
<p>Putting it all together I can create a step definition like this:</p>
<pre>
When /^I click "delete" for "(.*)"$/ do |desc|
task = Task.find_by_description(desc)
within("table &gt; tr#task"+task.id.to_s) do
click_link "Destroy"
end
end
</pre>
<p>I run &#8220;rake features&#8221; and all is good.  The only thing left to do is to rename the &#8220;Destroy&#8221; link to be &#8220;delete&#8221; as I described it and fix up the step to have a more general definition:</p>
<pre class="code">
When /^I click "(.*)" for "(.*)"$/ do |link, desc|
task = Task.find_by_description(desc)
within("table &gt; tr#task"+task.id.to_s) do
click_link link
end
end
</pre>
<p>I run &#8220;rake features&#8221; and see that 26 steps passed. Woo hoo!  Code coverage shows 83.8% of the controller file (everything but those pesky error conditions.) </p>
<p><a name="refactor"></p>
<h1>Refactor to Remove Duplication</h1>
<p></a></p>
<p>Now that the feature description roughly covers the functionality of our app, I sought to take Matt&#8217;s advice and look at the code and see if we need to remove some duplication.<br />
I looked first at the controller and found something odd:</p>
<p><code>in <strong>app/controllers/tasks_controllers.rb</strong>:</code></p>
<pre class="code">
class TasksController  @tasks }
end
end

# GET /tasks/new
# GET /tasks/new.xml
def new
@task = Task.new

respond_to do |format|
format.html # new.html.erb
format.xml  { render :xml =&gt; @task }
end
end

# GET /tasks/1/edit
def edit
@task = Task.find(params[:id])
end
</pre>
<p>The index and new methods repeat code, but the edit method, which I would expect to contain the same repeated 4 lines omits the code.  In fact, if I remove those lines in index and new, the app works fine.</p>
<pre class="code">
class TasksController &lt; ApplicationController
# GET /tasks
# GET /tasks.xml
def index
@tasks = Task.find(:all)
end

# GET /tasks/new
# GET /tasks/new.xml
def new
@task = Task.new
end

# GET /tasks/1/edit
def edit
@task = Task.find(params[:id])
end
</pre>
<p>When I run &#8216;rake features&#8217; all the steps pass and poking at the application also yields success.  What&#8217;s going on?  There must be something happening by default.  At first I couldn&#8217;t figure out where ApplicationController was defined, but an answer to my <a href="http://www.ruby-forum.com/topic/174419#764163">question on the Rails list</a> pointed out that ApplicationController is one of the classes created by generate scaffold (defined in app/controllers/application.rb). Looking at the code (and comments) we can see that it simply sets some defaults for any controller in the application. ApplicationController is a subclass of ActionController::Base, which we can look up in the <a href="http://api.rubyonrails.org/">Rails API Doc</a>.  The doc explains that &#8220;Actions, by default, render a template in the app/views directory corresponding to the name of the controller and action after executing code in the action.&#8221;  I suppose the extra code is in there to facilitate modifying it, in case we wanted the action to do something special.</p>
<p><a name="review"></p>
<h1>What did we learn?</h1>
<p></a></p>
<p>Today we learned about:</p>
<ul>
<li>installing and using RCov</li>
<li>cucumber steps that can be quickly defined using webrat</li>
<li>dynamic-attribute finders: find_by</li>
<li>adding a unique DOM id to more easily test the app</li>
</ul>
<p>We also learned that you need to understand code in order to refactor it, but, of course, we already knew that :)</p>
<p>There ends day 4, but I still haven&#8217;t completed all of the features of the Four Days on Rails tutorial.  Topics yet to learn:</p>
<ul>
<li>Adding attributes and other models: do I scaffold again or just write code?</li>
<li>Associated Models</li>
<li>Pagination</li>
<li>Updating multiple records</li>
</ul>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="cat-links block">Posted in <a href="https://www.ultrasaurus.com/category/code/" rel="category tag">code</a>.</span>	</footer><!-- .entry-footer -->
	
	</article><!-- #post-600 -->
		<div id="comments">
			<h2 id="comments-title">
				4 thoughts on &ldquo;<span>rails 2 day 4: rcov and more behavior-driven development</span>&rdquo;			</h2>
		
					
			<ol class="commentlist unstyled">
						
		<li  id="li-comment-354" class="comment even thread-even depth-1">
			<article id="comment-354" class="comment row">
				<div class="comment-author-avatar span1">
					<img alt='' src='https://secure.gravatar.com/avatar/bea84e7fd351176b661edc3c19355fa4?s=70&#038;r=g' srcset='https://secure.gravatar.com/avatar/bea84e7fd351176b661edc3c19355fa4?s=140&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' loading='lazy'/>				</div>
				<footer class="comment-meta span7">
					<p class="comment-author vcard">
						<span class="fn"><a href='http://thoughtless.ca' rel='external nofollow ugc' class='url'>Paul</a></span> <span class="says">said</span> on <a href="https://www.ultrasaurus.com/2008/12/rails-2-day-4-rcov-and-more-behavior-driven-development/#comment-354"><time pubdate datetime="2009-01-19T22:25:44-08:00">January 19, 2009 at 10:25 pm</time></a>:					</p><!-- .comment-author .vcard -->
	
						
				</footer><!-- .comment-meta -->
	
				<div class="comment-content span7">
					<p>Hi.<br />
This is a great post. I have a couple small suggestions:</p>
<p>change this <code>&lt;tr id="&lt;%="task"+task.id.to_s%&gt;"&gt;</code><br />
to this <code>&lt;tr id="&lt;%= dom_id(task) %&gt;"&gt;</code></p>
<p>That will produce output like task_1, task_2, etc. That&#8217;s just a bit more of a &#8220;Rails&#8221; way to do it.</p>
<p>Then in your matcher, you could change this <code>within("table &gt; tr#task"+task.id.to_s) do</code><br />
to this <code>within("table &gt; tr#task_#{task.id}") do</code></p>
<p>Or you could include <code>ActionView::Helpers::RecordIdentificationHelper</code> and then change it to this <code>within("table &gt; tr##{dom_id task}") do</code></p>
<p>Cheers</p>
				</div><!-- .comment-content -->
			</article><!-- #comment-354 .comment -->
			
	</li><!-- #comment-## -->
		
		<li  id="li-comment-355" class="comment odd alt thread-odd thread-alt depth-1">
			<article id="comment-355" class="comment row">
				<div class="comment-author-avatar span1">
					<img alt='' src='https://secure.gravatar.com/avatar/518394cf1a97e96f1de7d97481b30e15?s=70&#038;r=g' srcset='https://secure.gravatar.com/avatar/518394cf1a97e96f1de7d97481b30e15?s=140&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' loading='lazy'/>				</div>
				<footer class="comment-meta span7">
					<p class="comment-author vcard">
						<span class="fn">Ansgar</span> <span class="says">said</span> on <a href="https://www.ultrasaurus.com/2008/12/rails-2-day-4-rcov-and-more-behavior-driven-development/#comment-355"><time pubdate datetime="2009-02-06T04:58:29-08:00">February 6, 2009 at 4:58 am</time></a>:					</p><!-- .comment-author .vcard -->
	
						
				</footer><!-- .comment-meta -->
	
				<div class="comment-content span7">
					<p>Hi Sarah,<br />
thank you for this tutorial.</p>
<p>One note to the last refactoring (respond_to block).<br />
This block is there to return the data in the requested format.  So<br />
format.html returns the web page as we know it and<br />
format.xml returns the data in xml format (try <a href="http://localhost:3000/tasks.xml" rel="nofollow ugc">http://localhost:3000/tasks.xml</a>).</p>
<p>Ansgar</p>
				</div><!-- .comment-content -->
			</article><!-- #comment-355 .comment -->
			
	</li><!-- #comment-## -->
		
		<li  id="li-comment-356" class="comment even thread-even depth-1">
			<article id="comment-356" class="comment row">
				<div class="comment-author-avatar span1">
					<img alt='' src='https://secure.gravatar.com/avatar/08f5074f343d9834d5ce38fa1ada6dfc?s=70&#038;r=g' srcset='https://secure.gravatar.com/avatar/08f5074f343d9834d5ce38fa1ada6dfc?s=140&#038;r=g 2x' class='avatar avatar-70 photo' height='70' width='70' loading='lazy'/>				</div>
				<footer class="comment-meta span7">
					<p class="comment-author vcard">
						<span class="fn">markiv</span> <span class="says">said</span> on <a href="https://www.ultrasaurus.com/2008/12/rails-2-day-4-rcov-and-more-behavior-driven-development/#comment-356"><time pubdate datetime="2009-10-16T17:06:25-07:00">October 16, 2009 at 5:06 pm</time></a>:					</p><!-- .comment-author .vcard -->
	
						
				</footer><!-- .comment-meta -->
	
				<div class="comment-content span7">
					<p>Thanks for the great post&#8230;.</p>
				</div><!-- .comment-content -->
			</article><!-- #comment-356 .comment -->
			
	</li><!-- #comment-## -->
	
		<li id="li-comment-357" class="pingback odd alt thread-odd thread-alt depth-1">
			<p class="row">
				<strong class="ping-label span1">Pingback:</strong>
				<span class="span7"><a href='http://codesennin.com/cucumber-and-rspec-resources/' rel='external nofollow ugc' class='url'>Cucumber and RSpec resources | Codesennin</a></span>
			</p>
	
	</li><!-- #comment-## -->
			</ol><!-- .commentlist .unstyled -->
		
					
		</div><!-- #comments -->
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"><legend>Leave a reply</legend> <small><a rel="nofollow" id="cancel-comment-reply-link" href="/2008/12/rails-2-day-4-rcov-and-more-behavior-driven-development/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://www.ultrasaurus.com/wp-comments-post.php" method="post" id="commentform" class="comment-form"><div class="form-horizontal"><div class="comment-form-comment control-group"><label class="control-label" for="comment">Comment</label><div class="controls"><textarea autocomplete="new-password"  class="span7" id="efc0561732"  name="efc0561732"   rows="8" aria-required="true"></textarea><textarea id="comment" aria-hidden="true" name="comment" autocomplete="new-password" style="padding:0 !important;clip:rect(1px, 1px, 1px, 1px) !important;position:absolute !important;white-space:nowrap !important;height:1px !important;width:1px !important;overflow:hidden !important;" tabindex="-1"></textarea><script data-noptimize type="text/javascript">document.getElementById("comment").setAttribute( "id", "a4a8779a103774e74ccba605573843bd" );document.getElementById("efc0561732").setAttribute( "id", "comment" );</script></div></div><div class="form-allowed-tags control-group"><label class="control-label">You may use these <abbr title="HyperText Markup Language">HTML</abbr> tags and attributes: </label><div class="controls"><pre>&lt;a href=&quot;&quot; title=&quot;&quot;&gt; &lt;abbr title=&quot;&quot;&gt; &lt;acronym title=&quot;&quot;&gt; &lt;b&gt; &lt;blockquote cite=&quot;&quot;&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=&quot;&quot;&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=&quot;&quot;&gt; &lt;s&gt; &lt;strike&gt; &lt;strong&gt; </pre></div></div>
									 <div class="form-actions"><div class="comment-form-author control-group">
				<label for="author" class="control-label">Name</label>
				<div class="controls">
					<input id="author" name="author" type="text" value="" size="30" aria-required='true' />
					<p class="help-inline"><span class="required">required</span></p>
				</div>
			</div>
<div class="comment-form-email control-group">
				<label for="email" class="control-label">Email</label>
				<div class="controls">
					<input id="email" name="email" type="email" value="" size="30" aria-required='true' />
					<p class="help-inline"><span class="required">required</span>, will not be published</p>
				</div>
			</div>
<div class="comment-form-url control-group">
				<label for="url" class="control-label">Website</label>
				<div class="controls">
					<input id="url" name="url" type="url" value="" size="30" />
				</div>
			</div>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='600' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p></div></div></form>	</div><!-- #respond -->
			
		<nav id="nav-single" class="pager">
			<h3 class="assistive-text">Post navigation</h3>
			<span class="next"><a href="https://www.ultrasaurus.com/2008/12/history-of-the-santa-tracker/" rel="next">Next Post <span class="meta-nav">&rarr;</span></a></span>
			<span class="previous"><a href="https://www.ultrasaurus.com/2008/12/situated-learning-through-open-source/" rel="prev"><span class="meta-nav">&larr;</span> Previous Post</a></span>
		</nav><!-- #nav-single -->
		
			</div><!-- #content -->
	</section><!-- #primary -->

<section id="secondary" class="widget-area span4" role="complementary">
	<aside id="recent-comments-2" class="widget well widget_recent_comments"><h2 class="widget-title">Recent Comments</h2><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link"><a href='https://da.biomarmicrobialtechnologies.com/' rel='external nofollow ugc' class='url'>Silje Randrup</a></span> on <a href="https://www.ultrasaurus.com/2003/08/the-history-of-the-letter-c/#comment-22370">the history of the letter &#8216;C&#8217;</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://x--x.us' rel='external nofollow ugc' class='url'>Paula</a></span> on <a href="https://www.ultrasaurus.com/2003/08/the-history-of-the-letter-c/#comment-19549">the history of the letter &#8216;C&#8217;</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://x--x.us' rel='external nofollow ugc' class='url'>Michelle</a></span> on <a href="https://www.ultrasaurus.com/2003/08/the-history-of-the-letter-c/#comment-19399">the history of the letter &#8216;C&#8217;</a></li><li class="recentcomments"><span class="comment-author-link">Craig</span> on <a href="https://www.ultrasaurus.com/2019/10/http-3-starter-notes-rust-quiche/#comment-18963">http/3 starter notes, rust quiche</a></li><li class="recentcomments"><span class="comment-author-link">Kornel</span> on <a href="https://www.ultrasaurus.com/2019/10/rust-whats-a-tuple-variant/#comment-18539">[rust] what&#8217;s a tuple variant?</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://apromixately.github.io' rel='external nofollow ugc' class='url'>Simon</a></span> on <a href="https://www.ultrasaurus.com/2019/06/essential-rust-tools/#comment-13007">essential rust tools</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://balsamiq.com/company/' rel='external nofollow ugc' class='url'>balsamiqVal</a></span> on <a href="https://www.ultrasaurus.com/2018/10/the-path-is-made-by-walking/#comment-9108">the path is made by walking</a></li><li class="recentcomments"><span class="comment-author-link">Jennifer</span> on <a href="https://www.ultrasaurus.com/2018/07/optimize-for-results-not-optics/#comment-8193">optimize for results, not optics</a></li><li class="recentcomments"><span class="comment-author-link">Bernardo Gomes</span> on <a href="https://www.ultrasaurus.com/2016/06/sailsjs-testing-patterns-trunctate-database/#comment-8058">sailsjs testing: how to truncate the database</a></li><li class="recentcomments"><span class="comment-author-link">Bernardo Gomes</span> on <a href="https://www.ultrasaurus.com/2016/06/sailsjs-testing-patterns-trunctate-database/#comment-8057">sailsjs testing: how to truncate the database</a></li></ul></aside>
		<aside id="recent-posts-2" class="widget well widget_recent_entries">
		<h2 class="widget-title">Recent Posts</h2>
		<ul>
											<li>
					<a href="https://www.ultrasaurus.com/2020/07/hope-is-not-a-strategy/">hope is not a strategy</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2020/01/duck-typing-in-rust-trait-vs-type/">duck typing in rust: trait vs type</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2020/01/writing-c-library-in-rust/">writing c library in rust</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2020/01/rust-on-heroku-with-hyper-http/">rust on heroku with hyper http</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2020/01/rust-on-heroku-with-async-await-and-tokio/">rust on heroku with async/await and tokio</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/12/patterns-of-actions-are-a-making/">patterns of actions are a making</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/12/memory-safety-necessary-not-sufficient/">memory safety: necessary, not sufficient</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/12/brief-history-of-rtmp-future-thoughts/">brief history of rtmp + future thoughts</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/12/rust-2020/">rust 2020: fulfill the promise</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/11/nut-loaf-with-red-pepper-sauce/">nut loaf with red pepper sauce</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/10/http-3-starter-notes-rust-quiche/">http/3 starter notes, rust quiche</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/10/rust-whats-a-tuple-variant/">[rust] what&#8217;s a tuple variant?</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/08/graph-in-rust-using-petgraph/">graph in rust using petgraph</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/06/debugging-openssl-shared-libary/">debugging openssl shared libary</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/06/digital-identity-how-to-verify-trust/">digital identity: how to verify trust?</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/06/essential-rust-tools/">essential rust tools</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/05/learning-scala-with-graphics/">learning scala with graphics</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/04/when-reality-is-broken-change-the-rules/">when reality is broken, change the rules</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/04/subverting-saurons-business-model/">subverting Sauron&#8217;s business model</a>
									</li>
											<li>
					<a href="https://www.ultrasaurus.com/2019/02/firebase-auth-migration-from-rails-and-devise/">firebase auth migration from rails/devise</a>
									</li>
					</ul>

		</aside></section><!-- #secondary .widget-area -->
				<footer id="colophon" role="contentinfo" class="span12">
										<div id="page-footer" class="well clearfix">
						<span class="credits alignleft">&copy; 2021 <a href="https://www.ultrasaurus.com/">the evolving ultrasaurus</a>, all rights reserved.</span>						<div id="site-generator">
							<a	href="http://wordpress.org/"
								title="Semantic Personal Publishing Platform"
								target="_blank"
								rel="generator">Proudly powered by WordPress</a>
						</div>
					</div><!-- #page-footer .well .clearfix -->
									</footer><!-- #colophon -->
							</div><!-- #page -->
		</div><!-- .container -->
	<!-- 48 queries. 0.372 seconds. -->
	<script type='text/javascript' src='https://www.ultrasaurus.com/wp-content/themes/the-bootstrap/js/bootstrap.min.js?ver=2.0.3' id='tw-bootstrap-js'></script>
<script type='text/javascript' src='https://www.ultrasaurus.com/wp-content/themes/the-bootstrap/js/the-bootstrap.min.js?ver=2.0.1' id='the-bootstrap-js'></script>
<script type='text/javascript' src='https://www.ultrasaurus.com/wp-includes/js/wp-embed.min.js?ver=5.7.1' id='wp-embed-js'></script>
	</body>
</html>
